# å®‰å…¨é—®é¢˜ä¿®å¤æŠ¥å‘Š

## ä¿®å¤æ—¶é—´
2025-11-05

## é—®é¢˜å‘ç°
ç”¨æˆ·æŠ¥å‘Šå‘ç°ä»¥ä¸‹å…³é”®å®‰å…¨é—®é¢˜ï¼š
- ğŸ”´ JWTå¯†é’¥ä½¿ç”¨é»˜è®¤å€¼ï¼ˆå®‰å…¨é£é™©ï¼‰
- ğŸ”´ æ•°æ®åº“å¯†ç ç¡¬ç¼–ç ï¼ˆå®‰å…¨é£é™©ï¼‰
- ğŸ”´ Redisæœªé…ç½®å¯†ç ï¼ˆå®‰å…¨é£é™©ï¼‰
- ğŸŸ¡ å­˜åœ¨ä¸¤ä¸ªdocker-compose.ymlé…ç½®ä¸ä¸€è‡´
- ğŸŸ¡ éƒ¨åˆ†APIä»ä½¿ç”¨å·²åºŸå¼ƒæ–¹æ³•

---

## ä¿®å¤è¯¦æƒ…

### 1. JWTå¯†é’¥å®‰å…¨åŠ å›º ğŸ”´ é«˜å±

**é—®é¢˜æè¿°**ï¼š
- JWTå¯†é’¥ç¡¬ç¼–ç åœ¨ä»£ç ä¸­ï¼š`userprofile-secret-key-change-in-production-min-256-bits-required`
- ä»»ä½•äººéƒ½èƒ½ä½¿ç”¨é»˜è®¤å¯†é’¥ä¼ªé€ JWTä»¤ç‰Œ
- å­˜åœ¨ä¸¥é‡çš„èº«ä»½éªŒè¯ç»•è¿‡é£é™©

**ä¿®å¤æªæ–½**ï¼š
```java
// ä¿®æ”¹å‰
@Value("${jwt.secret:userprofile-secret-key-change-in-production-min-256-bits-required}")
private String jwtSecret;

// ä¿®æ”¹å
@Value("${jwt.secret:}")  // æ— é»˜è®¤å€¼
private String jwtSecret;

// æ·»åŠ å¯åŠ¨éªŒè¯
private void validateSecretKey() {
    if (jwtSecret == null || jwtSecret.trim().isEmpty()) {
        throw new IllegalStateException("JWTå¯†é’¥æœªé…ç½®");
    }
    if (jwtSecret.length() < 32) {
        throw new IllegalStateException("JWTå¯†é’¥é•¿åº¦ä¸è¶³");
    }
}
```

**éªŒè¯æ–¹æ³•**ï¼š
- æœªé…ç½®JWTå¯†é’¥æ—¶ç³»ç»Ÿæ‹’ç»å¯åŠ¨
- å¯†é’¥é•¿åº¦ä¸è¶³32å­—ç¬¦æ—¶ç³»ç»Ÿæ‹’ç»å¯åŠ¨
- å¯åŠ¨æ—¥å¿—ä¼šæ˜¾ç¤ºéªŒè¯ç»“æœ

**å½±å“**ï¼š
- âœ… å½»åº•æ¶ˆé™¤é»˜è®¤å¯†é’¥é£é™©
- âœ… å¼ºåˆ¶ç”Ÿäº§ç¯å¢ƒé…ç½®å¼ºå¯†é’¥
- âš ï¸ éœ€è¦åœ¨éƒ¨ç½²æ—¶é…ç½®JWT_SECRETç¯å¢ƒå˜é‡

---

### 2. æ•°æ®åº“å¯†ç å®‰å…¨ ğŸ”´ é«˜å±

**é—®é¢˜æè¿°**ï¼š
- MySQL rootå¯†ç ï¼š`root123`
- MongoDBå¯†ç ï¼š`admin123`
- Rediså¯†ç ï¼š`redis123`
- è¿™äº›å¼±å¯†ç åœ¨æ–‡æ¡£å’Œé…ç½®ä¸­ç¡¬ç¼–ç 

**ä¿®å¤æªæ–½**ï¼š

**A. æ›´æ–°.env.example**
```env
# ä¿®æ”¹å‰
MYSQL_ROOT_PASSWORD=root123
MONGO_PASSWORD=admin123
REDIS_PASSWORD=redis123

# ä¿®æ”¹å
MYSQL_ROOT_PASSWORD=CHANGE_THIS_IN_PRODUCTION
MONGO_PASSWORD=CHANGE_THIS_IN_PRODUCTION
REDIS_PASSWORD=CHANGE_THIS_IN_PRODUCTION
```

**B. æ›´æ–°quick-start.shè‡ªåŠ¨ç”Ÿæˆ**
```bash
# ç”Ÿæˆ24å­—ç¬¦å¼ºéšæœºå¯†ç 
MYSQL_ROOT_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/")
MYSQL_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/")
MONGO_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/")
REDIS_PASSWORD=$(openssl rand -base64 24 | tr -d "=+/")
JWT_SECRET=$(openssl rand -base64 48 | tr -d "=+/")
```

**éªŒè¯æ–¹æ³•**ï¼š
- è¿è¡Œ `./quick-start.sh` åæ£€æŸ¥ `.env` æ–‡ä»¶
- å¯†ç åº”ä¸º24å­—ç¬¦éšæœºå­—ç¬¦ä¸²
- JWTå¯†é’¥åº”ä¸º48å­—ç¬¦éšæœºå­—ç¬¦ä¸²

**å½±å“**ï¼š
- âœ… æ¶ˆé™¤å¼±å¯†ç é£é™©
- âœ… æ¯æ¬¡éƒ¨ç½²è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€å¯†ç 
- âš ï¸ éœ€è¦å¤‡ä»½ç”Ÿæˆçš„ `.env` æ–‡ä»¶

---

### 3. Rediså¯†ç é…ç½® ğŸ”´ é«˜å±

**é—®é¢˜æè¿°**ï¼š
- `backend/docker-compose.yml` ä¸­RedisæœåŠ¡æœªé…ç½® `requirepass`
- Rediså®Œå…¨æ— è®¤è¯ï¼Œä»»ä½•äººå¯è®¿é—®

**ä¿®å¤æªæ–½**ï¼š
- åˆ é™¤ `backend/docker-compose.yml`ï¼ˆå†—ä½™é…ç½®æ–‡ä»¶ï¼‰
- ä¸» `docker-compose.yml` å·²æ­£ç¡®é…ç½®Rediså¯†ç ï¼š
```yaml
redis:
  command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}
```

**éªŒè¯æ–¹æ³•**ï¼š
```bash
# å°è¯•æ— å¯†ç è¿æ¥ï¼ˆåº”å¤±è´¥ï¼‰
docker exec ups-redis redis-cli ping
# è¾“å‡º: (error) NOAUTH Authentication required.

# ä½¿ç”¨å¯†ç è¿æ¥ï¼ˆåº”æˆåŠŸï¼‰
docker exec ups-redis redis-cli -a $REDIS_PASSWORD ping
# è¾“å‡º: PONG
```

**å½±å“**ï¼š
- âœ… Redisç°åœ¨éœ€è¦å¯†ç è®¤è¯
- âœ… é˜²æ­¢æœªæˆæƒè®¿é—®ç¼“å­˜æ•°æ®

---

### 4. åºŸå¼ƒAPIæ›¿æ¢ ğŸŸ¡ ä¸­å±

**é—®é¢˜æè¿°**ï¼š
- `JwtTokenProvider.java` ä½¿ç”¨åºŸå¼ƒçš„ `java.util.Date`
- åº”ä½¿ç”¨ç°ä»£çš„ `java.time` API

**ä¿®å¤æªæ–½**ï¼š
```java
// ä¿®æ”¹å‰
Date now = new Date();
Date expiryDate = new Date(now.getTime() + jwtExpirationMs);

// ä¿®æ”¹å
Instant now = Instant.now();
Instant expiryDate = now.plusMillis(jwtExpirationMs);
...
.issuedAt(Date.from(now))
.expiration(Date.from(expiryDate))
```

**å½±å“**ï¼š
- âœ… ä½¿ç”¨ç°ä»£æ—¶é—´API
- âœ… æ›´å¥½çš„çº¿ç¨‹å®‰å…¨æ€§
- âœ… æ›´æ¸…æ™°çš„æ—¶é—´è®¡ç®—é€»è¾‘

---

### 5. é…ç½®æ–‡ä»¶æ•´ç† ğŸŸ¡ ä¸­å±

**é—®é¢˜æè¿°**ï¼š
- å­˜åœ¨ä¸¤ä¸ªdocker-compose.ymlï¼š
  - `./docker-compose.yml`ï¼ˆä½¿ç”¨MySQLï¼‰
  - `./backend/docker-compose.yml`ï¼ˆä½¿ç”¨PostgreSQLï¼‰
- é…ç½®ä¸ä¸€è‡´ï¼Œå®¹æ˜“æ··æ·†

**ä¿®å¤æªæ–½**ï¼š
- åˆ é™¤ `backend/docker-compose.yml`
- åˆ é™¤ `backend/.env.example`
- ç»Ÿä¸€ä½¿ç”¨æ ¹ç›®å½•çš„é…ç½®æ–‡ä»¶

**å½±å“**ï¼š
- âœ… æ¶ˆé™¤é…ç½®ä¸ä¸€è‡´é—®é¢˜
- âœ… ç®€åŒ–éƒ¨ç½²æµç¨‹
- âœ… å‡å°‘ç»´æŠ¤æˆæœ¬

---

## æ–‡æ¡£æ›´æ–°

### 1. DEPLOYMENT.md
- æ·»åŠ å®‰å…¨è­¦å‘Šå’Œé…ç½®è¯´æ˜
- æ›´æ–°ç¯å¢ƒå˜é‡ç¤ºä¾‹ï¼ˆç§»é™¤å¼±å¯†ç ï¼‰
- æ·»åŠ å¯†é’¥ç”Ÿæˆæ–¹æ³•
- æ‰©å±•å®‰å…¨åŠ å›ºç« èŠ‚

### 2. æ–°å¢SECURITY.md
åˆ›å»ºå®Œæ•´çš„å®‰å…¨é…ç½®æŒ‡å—ï¼ŒåŒ…å«ï¼š
- JWTå®‰å…¨é…ç½®
- æ•°æ®åº“å®‰å…¨é…ç½®
- Rediså®‰å…¨é…ç½®
- ç½‘ç»œå®‰å…¨é…ç½®
- SSL/TLSé…ç½®
- å¯†é’¥ç®¡ç†æœ€ä½³å®è·µ
- å®¡è®¡ä¸ç›‘æ§
- å®‰å…¨æ£€æŸ¥æ¸…å•
- åº”æ€¥å“åº”æµç¨‹

---

## å½±å“èŒƒå›´

### å¯¹ç°æœ‰éƒ¨ç½²çš„å½±å“

**å·²éƒ¨ç½²çš„ç³»ç»Ÿ**ï¼š
- âš ï¸ éœ€è¦é‡æ–°é…ç½®JWTå¯†é’¥
- âš ï¸ éœ€è¦é‡æ–°é…ç½®æ•°æ®åº“å¯†ç 
- âš ï¸ éœ€è¦é‡å¯æ‰€æœ‰æœåŠ¡

**æ–°éƒ¨ç½²**ï¼š
- âœ… ä½¿ç”¨ `quick-start.sh` ä¼šè‡ªåŠ¨ç”Ÿæˆå®‰å…¨é…ç½®
- âœ… æ‰‹åŠ¨éƒ¨ç½²éœ€è¦æŒ‰ç…§æ–°æ–‡æ¡£é…ç½®

### å‡çº§æ­¥éª¤

**ä»æ—§ç‰ˆæœ¬å‡çº§**ï¼š

```bash
# 1. æ‹‰å–æœ€æ–°ä»£ç 
git pull origin main

# 2. ç”Ÿæˆæ–°çš„å®‰å…¨é…ç½®
openssl rand -base64 48 | tr -d "=+/" > jwt_secret.txt
openssl rand -base64 24 | tr -d "=+/" > mysql_password.txt
openssl rand -base64 24 | tr -d "=+/" > mongo_password.txt
openssl rand -base64 24 | tr -d "=+/" > redis_password.txt

# 3. æ›´æ–°.envæ–‡ä»¶
cat > .env << EOF
JWT_SECRET=$(cat jwt_secret.txt)
MYSQL_ROOT_PASSWORD=$(cat mysql_password.txt)
MYSQL_PASSWORD=$(cat mysql_password.txt)
MONGO_PASSWORD=$(cat mongo_password.txt)
REDIS_PASSWORD=$(cat redis_password.txt)
EOF

# 4. é‡æ–°æ„å»ºå’Œå¯åŠ¨
docker-compose down
docker-compose build
docker-compose up -d

# 5. éªŒè¯æœåŠ¡
docker-compose ps
docker-compose logs gateway-service | grep JWT
```

---

## å®‰å…¨æ£€æŸ¥æ¸…å•

### éƒ¨ç½²å‰å¿…æ£€é¡¹

- [x] JWTå¯†é’¥é•¿åº¦â‰¥32å­—ç¬¦
- [x] æ‰€æœ‰æ•°æ®åº“å¯†ç å·²ä¿®æ”¹
- [x] Rediså·²é…ç½®å¯†ç 
- [x] .envæ–‡ä»¶å·²åŠ å…¥.gitignore
- [x] ç§»é™¤æ‰€æœ‰ç¡¬ç¼–ç å¯†ç 
- [x] ç³»ç»Ÿå¯åŠ¨æ—¶éªŒè¯å®‰å…¨é…ç½®
- [x] æ–‡æ¡£å·²æ›´æ–°å®‰å…¨è¯´æ˜

### è¿è¡Œæ—¶éªŒè¯

```bash
# 1. æ£€æŸ¥JWTé…ç½®
docker-compose logs gateway-service | grep -i jwt

# 2. æ£€æŸ¥Redisè®¤è¯
docker exec ups-redis redis-cli ping
# åº”è¾“å‡º: (error) NOAUTH Authentication required.

# 3. æ£€æŸ¥MySQLå¯†ç 
docker exec ups-mysql mysql -uroot -proot123 -e "SELECT 1"
# åº”å¤±è´¥ï¼ˆæ—§å¯†ç ï¼‰

# 4. æ£€æŸ¥æœåŠ¡å¥åº·
curl http://localhost:8080/actuator/health
```

---

## æµ‹è¯•ç»“æœ

### å®‰å…¨æµ‹è¯•

| æµ‹è¯•é¡¹ | æµ‹è¯•æ–¹æ³• | ç»“æœ |
|-------|---------|------|
| JWTé»˜è®¤å¯†é’¥ | å°è¯•ä¸é…ç½®JWT_SECRETå¯åŠ¨ | âœ… æ‹’ç»å¯åŠ¨ |
| JWTçŸ­å¯†é’¥ | é…ç½®20å­—ç¬¦å¯†é’¥ | âœ… æ‹’ç»å¯åŠ¨ |
| Redisæ— å¯†ç è®¿é—® | redis-cli ping | âœ… æ‹’ç»è®¿é—® |
| MySQLå¼±å¯†ç  | ä½¿ç”¨root123ç™»å½• | âœ… æ‹’ç»è®¿é—® |
| é…ç½®æ–‡ä»¶å†²çª | æ£€æŸ¥docker-composeæ•°é‡ | âœ… ä»…ä¸€ä¸ª |

### åŠŸèƒ½æµ‹è¯•

| åŠŸèƒ½ | æµ‹è¯•ç»“æœ | è¯´æ˜ |
|------|---------|------|
| ç”¨æˆ·æ³¨å†Œ | âœ… é€šè¿‡ | JWTæ­£å¸¸ç”Ÿæˆ |
| ç”¨æˆ·ç™»å½• | âœ… é€šè¿‡ | JWTæ­£å¸¸éªŒè¯ |
| APIè°ƒç”¨ | âœ… é€šè¿‡ | Redisç¼“å­˜æ­£å¸¸ |
| æ•°æ®æŒä¹…åŒ– | âœ… é€šè¿‡ | MySQL/MongoDBæ­£å¸¸ |

---

## å»ºè®®åç»­æ”¹è¿›

### çŸ­æœŸï¼ˆ1-2å‘¨ï¼‰

1. **æ·»åŠ å¯†é’¥è½®æ¢æœºåˆ¶**
   - æ”¯æŒåŒJWTå¯†é’¥å¹¶å­˜
   - å®ç°å¹³æ»‘å¯†é’¥åˆ‡æ¢
   - è‡ªåŠ¨è¿‡æœŸæ—§å¯†é’¥

2. **å¢å¼ºæ—¥å¿—å®¡è®¡**
   - è®°å½•JWTéªŒè¯å¤±è´¥
   - è®°å½•æ•°æ®åº“è¿æ¥å¤±è´¥
   - è®°å½•å¼‚å¸¸APIè°ƒç”¨

3. **æ·»åŠ ç›‘æ§å‘Šè­¦**
   - JWTéªŒè¯å¤±è´¥ç‡å‘Šè­¦
   - æ•°æ®åº“è¿æ¥å¤±è´¥å‘Šè­¦
   - Redisè®¤è¯å¤±è´¥å‘Šè­¦

### ä¸­æœŸï¼ˆ1-2ä¸ªæœˆï¼‰

1. **é›†æˆå¯†é’¥ç®¡ç†æœåŠ¡**
   - æ”¯æŒHashiCorp Vault
   - æ”¯æŒAWS Secrets Manager
   - æ”¯æŒAzure Key Vault

2. **å®ç°OAuth2/OIDC**
   - æ”¯æŒç¬¬ä¸‰æ–¹ç™»å½•
   - ç»Ÿä¸€è®¤è¯æˆæƒ
   - å•ç‚¹ç™»å½•(SSO)

3. **æ·»åŠ APIç½‘å…³å®‰å…¨**
   - IPç™½åå•
   - APIç­¾åéªŒè¯
   - é˜²é‡æ”¾æ”»å‡»

### é•¿æœŸï¼ˆ3-6ä¸ªæœˆï¼‰

1. **å®‰å…¨è®¤è¯**
   - é€šè¿‡OWASPå®‰å…¨å®¡è®¡
   - è·å–ISO 27001è®¤è¯
   - å®Œæˆæ¸—é€æµ‹è¯•

2. **è‡ªåŠ¨åŒ–å®‰å…¨**
   - é›†æˆSASTå·¥å…·
   - é›†æˆDASTå·¥å…·
   - é›†æˆä¾èµ–æ¼æ´æ‰«æ

---

## æ€»ç»“

### ä¿®å¤æˆæœ

- âœ… ä¿®å¤5ä¸ªå…³é”®å®‰å…¨é—®é¢˜
- âœ… æ›´æ–°2ä¸ªæ ¸å¿ƒæ–‡æ¡£
- âœ… æ–°å¢1ä¸ªå®‰å…¨æŒ‡å—
- âœ… åˆ é™¤2ä¸ªå†—ä½™é…ç½®æ–‡ä»¶
- âœ… æ›´æ–°1ä¸ªéƒ¨ç½²è„šæœ¬
- âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡

### å®‰å…¨ç­‰çº§æå‡

| é¡¹ç›® | ä¿®å¤å‰ | ä¿®å¤å |
|------|-------|-------|
| JWTå®‰å…¨ | ğŸ”´ é«˜å± | ğŸŸ¢ å®‰å…¨ |
| æ•°æ®åº“å¯†ç  | ğŸ”´ é«˜å± | ğŸŸ¢ å®‰å…¨ |
| Redisè®¤è¯ | ğŸ”´ é«˜å± | ğŸŸ¢ å®‰å…¨ |
| ä»£ç ç°ä»£åŒ– | ğŸŸ¡ ä¸­å± | ğŸŸ¢ å®‰å…¨ |
| é…ç½®ä¸€è‡´æ€§ | ğŸŸ¡ ä¸­å± | ğŸŸ¢ å®‰å…¨ |
| **æ•´ä½“è¯„ä¼°** | **ğŸ”´ é«˜å±** | **ğŸŸ¢ å®‰å…¨** |

### ç”¨æˆ·è¡ŒåŠ¨é¡¹

**ç«‹å³æ‰§è¡Œ**ï¼š
1. æ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼š`git pull origin main`
2. è¿è¡Œéƒ¨ç½²è„šæœ¬ï¼š`./quick-start.sh`
3. å¤‡ä»½ç”Ÿæˆçš„ `.env` æ–‡ä»¶
4. é˜…è¯» `SECURITY.md` äº†è§£å®‰å…¨æœ€ä½³å®è·µ

**å®šæœŸç»´æŠ¤**ï¼š
1. æ¯90å¤©è½®æ¢æ•°æ®åº“å¯†ç 
2. æ¯180å¤©è½®æ¢JWTå¯†é’¥
3. æ¯æœˆæ£€æŸ¥å®‰å…¨æ—¥å¿—
4. åŠæ—¶æ›´æ–°ä¾èµ–åŒ…

---

## è”ç³»æ–¹å¼

å¦‚æœ‰å®‰å…¨é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»ï¼š
- é‚®ç®±ï¼šb150w4942@163.com
- GitHub Issuesï¼šhttps://github.com/dctx479/UPS/issues

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-11-05
**ä¿®å¤ç‰ˆæœ¬**ï¼šv1.0
**Gitæäº¤**ï¼šaec5743
