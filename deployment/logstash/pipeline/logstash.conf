input {
  # 从JSON日志文件读取
  file {
    path => "/logs/*-json.log"
    codec => json
    type => "userprofile"
    start_position => "beginning"
    sincedb_path => "/dev/null"
  }

  # 从Filebeat接收
  beats {
    port => 5044
  }
}

filter {
  # 解析时间戳
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601"]
      target => "@timestamp"
    }
  }

  # 添加服务名标签
  if [app] {
    mutate {
      add_field => { "service" => "%{app}" }
    }
  }

  # 解析错误级别
  if [level] {
    mutate {
      uppercase => [ "level" ]
    }
  }

  # 为ERROR级别添加标签
  if [level] == "ERROR" {
    mutate {
      add_tag => ["error"]
    }
  }

  # 为WARN级别添加标签
  if [level] == "WARN" {
    mutate {
      add_tag => ["warning"]
    }
  }

  # 解析堆栈跟踪
  if [stack_trace] {
    mutate {
      add_tag => ["has_stack_trace"]
    }
  }

  # 移除不需要的字段
  mutate {
    remove_field => ["@version", "host", "path"]
  }
}

output {
  # 输出到Elasticsearch
  elasticsearch {
    hosts => ["elasticsearch:9200"]
    index => "userprofile-logs-%{+YYYY.MM.dd}"
    template_name => "userprofile"
    template_overwrite => true
  }

  # 开发调试输出
  # stdout {
  #   codec => rubydebug
  # }
}
