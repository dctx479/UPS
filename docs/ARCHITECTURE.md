# 系统架构

## 架构概览

```
┌─────────────┐
│   Flutter   │  前端应用
│   Client    │
└──────┬──────┘
       │
       ↓
┌─────────────────────────────────────────────────┐
│          API Gateway (Port 8080)                │
│  - 路由转发  - 限流保护  - 熔断降级             │
└────────┬────────────────────────────────────────┘
         │
    ┌────┴────┬─────────┬─────────┐
    ↓         ↓         ↓         ↓
┌────────┐┌──────────┐┌──────────┐
│ User   ││ Profile  ││   Tag    │
│Service ││ Service  ││ Service  │
│ :8081  ││  :8082   ││  :8083   │
└───┬────┘└────┬─────┘└────┬─────┘
    │          │            │
    ↓          ↓            ↓
┌────────┐┌──────────┐┌──────────┐
│Postgres││ MongoDB  ││  Redis   │
│ :5432  ││  :27017  ││  :6379   │
└────────┘└──────────┘└──────────┘
         │
         ↓
    ┌─────────┐
    │ Consul  │  服务发现
    │  :8500  │
    └─────────┘
```

## 核心组件

### 1. API Gateway
- **功能**: 统一入口、路由转发
- **特性**:
  - 基于IP的限流保护
  - 熔断降级机制
  - CORS跨域支持

### 2. User Service
- **功能**: 用户管理、认证授权
- **数据库**: PostgreSQL
- **特性**:
  - JWT认证
  - 强密码策略
  - 审计日志
  - 分布式事务补偿

### 3. Profile Service
- **功能**: 用户画像管理
- **数据库**: MongoDB
- **特性**:
  - 画像计算引擎
  - 自动初始化
  - Redis缓存
  - 性能优化索引

### 4. Tag Service
- **功能**: 标签管理
- **数据库**: PostgreSQL
- **特性**:
  - 批量操作
  - 标签去重
  - 权重调整

## 技术选型

### 后端框架
- **Spring Boot** 3.2.0 - 核心框架
- **Spring Cloud** - 微服务套件
- **Spring Security** - 安全框架
- **OpenFeign** - 服务调用

### 数据存储
- **PostgreSQL** - 关系型数据（用户、标签）
- **MongoDB** - 文档型数据（画像）
- **Redis** - 缓存层

### 服务治理
- **Consul** - 服务注册与发现
- **Resilience4j** - 熔断降级

### 前端技术
- **Flutter** - 跨平台UI框架
- **Provider** - 状态管理

## 数据流程

### 用户注册流程
```
1. Client → Gateway → User Service
2. User Service 创建用户 → PostgreSQL
3. 发布 UserCreatedEvent
4. Listener → Profile Service 初始化画像
5. 画像保存 → MongoDB
6. 补偿调度器定期检查数据一致性
```

### 画像查询流程
```
1. Client → Gateway → Profile Service
2. 检查 Redis 缓存
3. 缓存未命中 → MongoDB 查询（使用索引）
4. 结果写入缓存
5. 返回给 Client
```

## 性能优化

### MongoDB索引
- `userId` - 唯一索引
- `username` - 普通索引
- `updateTime` - 降序索引
- `profileScore` - 降序索引
- `userId + updateTime` - 复合索引

### Redis缓存策略
- **用户数据**: 30分钟过期
- **画像数据**: 1小时过期
- **缓存击穿保护**: sync=true

### API限流
- 认证接口: 50次/秒/IP
- 用户接口: 100次/秒/IP
- 画像接口: 100次/秒/IP
- 标签接口: 100次/秒/IP

## 高可用设计

### 服务发现
- Consul动态注册
- 健康检查（10秒间隔）
- 自动下线故障节点

### 熔断降级
- 滑动窗口: 10次请求
- 失败率阈值: 50%
- 熔断等待: 10秒

### 分布式事务
- 补偿机制（每小时检查）
- 启动时全面检查（最近7天）
- 审计日志记录

## 安全机制

- **认证**: JWT Token
- **密码**: BCrypt加密 + 强密码策略
- **限流**: IP级别限流
- **审计**: 13种操作类型追踪
- **CORS**: 配置允许的来源

## 扩展性

- **水平扩展**: 通过Consul动态发现多实例
- **数据库**: 支持读写分离和分库分表
- **缓存**: Redis集群支持
- **消息队列**: 预留事件总线接口
